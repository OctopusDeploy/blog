---
title: Creating AMI mappings for CloudFormation
description: Learn how to create region AMI mappings for use with CloudFormation Templates
author: matthew.casperson@octopus.com
visibility: private
published: 2999-01-01
metaImage: 
bannerImage: 
tags:
 - Octopus
---

Many of the services provided by AWS are specific to individual regions, and Amazon Machine Images (AMIs) are just one example. This means that while common AMIs are published to all regions, the AMI ID is unique per region.

This presents a challenge when writing CloudFormation scripts, as the AMI ID passed to EC2 resources is region specific, making your template region specific as well.

[Mappings](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-findinmap.html) can be used to write generic CloudFormation templates, where AMI IDs are mapped to a region and looked up when the template is deployed. Unfortunately, AMI IDs change frequently, and there are no easy mapping references to include in your templates.

In this post you'll learn how to generate an up to date mapping with the latest regional AMI IDs for inclusion in your CloudFormation templates.

## Prerequisites

The script requires `jq`. The `jq` [download page](https://stedolan.github.io/jq/download/) includes instructions for installing the tool for major Linux distributions.

## The lookup script

The Bash script below builds a CloudFormation map in YAML:

```bash
#!/usr/bin/env bash
echo "Mappings:"
echo "  RegionMap:"
regions=$(aws ec2 describe-regions --output text --query 'Regions[*].RegionName')
for region in $regions; do
    (
     echo "    $region:"
     AMI=$(aws ec2 describe-images --region $region --filters Name=is-public,Values=true Name=name,Values="$1*" | jq -r '.Images |= sort_by(.CreationDate) | .Images[0].ImageId')
     echo "      ami: $AMI"
    )
done
```

Save the script to a file like `amimap.sh`, and then mark the file as executable with the command:

```bash
chmod +x amimap.sh
```

The script is called with the AMI name (or the start of the AMI name) as the first argument:

```bash
./amimap.sh amzn2-ami-kernel-5.10-hvm
```

The output looks something like this:

```yaml
$ ./amimap.sh amzn2-ami-kernel-5.10-hvm
Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-0316697945888f67d
    ap-south-1:
      ami: ami-0e42cb8ae0f047d61
    eu-west-3:
      ami: ami-097896030ce439b72
    eu-west-2:
      ami: ami-098a48017321637ba
    eu-west-1:
      ami: ami-01a48ea7ae211d67f
    ap-northeast-3:
      ami: ami-063f2fc19624003f0
    ap-northeast-2:
      ami: ami-0b3257bd52976bb7b
    ap-northeast-1:
      ami: ami-0e8c575e9da02e760
    sa-east-1:
      ami: ami-0c7b955d5961cf96e
    ca-central-1:
      ami: ami-0353a1f881f25b3da
    ap-southeast-1:
      ami: ami-014e997c45a99cf9e
    ap-southeast-2:
      ami: ami-0e6728f614d3cc49a
    eu-central-1:
      ami: ami-003dd8d19fdb6ee2e
    us-east-1:
      ami: ami-092718474c995fa9f
    us-east-2:
      ami: ami-0ab38779954d9029a
    us-west-1:
      ami: ami-01828c2779c0ceaef
    us-west-2:
      ami: ami-005267ae5b254f8c2
```

## Using the mappings in CloudFormation

The following CloudFormation template demonstrates how the mappings generated by the script can be used:

```yaml
Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-0316697945888f67d
    ap-south-1:
      ami: ami-0e42cb8ae0f047d61
    eu-west-3:
      ami: ami-097896030ce439b72
    eu-west-2:
      ami: ami-098a48017321637ba
    eu-west-1:
      ami: ami-01a48ea7ae211d67f
    ap-northeast-3:
      ami: ami-063f2fc19624003f0
    ap-northeast-2:
      ami: ami-0b3257bd52976bb7b
    ap-northeast-1:
      ami: ami-0e8c575e9da02e760
    sa-east-1:
      ami: ami-0c7b955d5961cf96e
    ca-central-1:
      ami: ami-0353a1f881f25b3da
    ap-southeast-1:
      ami: ami-014e997c45a99cf9e
    ap-southeast-2:
      ami: ami-0e6728f614d3cc49a
    eu-central-1:
      ami: ami-003dd8d19fdb6ee2e
    us-east-1:
      ami: ami-092718474c995fa9f
    us-east-2:
      ami: ami-0ab38779954d9029a
    us-west-1:
      ami: ami-01828c2779c0ceaef
    us-west-2:
      ami: ami-005267ae5b254f8c2
Resources: 
  myEC2Instance: 
    Type: "AWS::EC2::Instance"
    Properties: 
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - ami
      InstanceType: m1.small
```

## Finding AMI names

You will notice from the command above that the start of the AMI name must be passed as a parameter. However, the AWS console typically shows the AMI description, which is more user friendly. So how do you find the name from the AMI ID or description?

An easy solution is to open the **Images** link in the EC2 console. This allows public AMIs to be searched for either their ID or description, and the AMI details page then displays the AMI name:

![AMI Details page](ami-details.png)

## Conclusion

Keeping your CloudFormation templates up to date with the latest AMI IDs is a constant challenge and is made more complicated by the fact that every region has unique AMI IDs. In this post you learned how to generate up to date mappings with regional AMI IDs to copy and paste into your CloudFormation templates.
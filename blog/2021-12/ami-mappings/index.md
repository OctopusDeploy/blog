---
title: Creating AMI mappings for CloudFormation
description: Learn how to create region AMI mappings for use with CloudFormation Templates
author: matthew.casperson@octopus.com
visibility: private
published: 2999-01-01
metaImage: 
bannerImage: 
tags:
 - Octopus
---

Many of the services provided by AWS are specific to individual regions, and Amazon Machine Images (AMIs) are just one example. So while common AMIs are published to all regions, the AMI ID is unique per region.

This presents a challenge when writing CloudFormation scripts, as the AMI ID passed to EC2 resources is region specific, making your template region specific as well.

[Mappings](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-findinmap.html) can be used to write generic CloudFormation templates, allowing AMI IDs are mapped to a region and looked up when the template is deployed. Unfortunately, AMI IDs change frequently, and there are no easy mapping references to include in your templates.

In this post you'll learn how to generate an up to date mapping with the latest regional AMI IDs for inclusion in your CloudFormation templates.

## Prerequisites

The script requires `jq`. The `jq` [download page](https://stedolan.github.io/jq/download/) includes instructions for installing the tool for major Linux distributions.

## The lookup script

The Bash script below builds a CloudFormation map in YAML:

```bash
#!/usr/bin/env bash
echo "Mappings:"
echo "  RegionMap:"
regions=$(aws ec2 describe-regions --output text --query 'Regions[*].RegionName')
for region in $regions; do
    (
     echo "    $region:"
     AMI=$(aws ec2 describe-images --region $region --filters Name=is-public,Values=true Name=name,Values="$1*" | jq -r '.Images |= sort_by(.CreationDate) | .Images[0].ImageId')
     echo "      ami: $AMI"
    )
done
```

Save the script to a file like `amimap.sh`, and then mark the file as executable with the command:

```bash
chmod +x amimap.sh
```

The script is called with the AMI name (or the start of the AMI name) as the first argument:

```bash
./amimap.sh amzn2-ami-kernel-5.10-hvm-2.0.20211103.1-x86_64
```

The output looks something like this:

```yaml
$ ./amimap.sh amzn2-ami-kernel-5.10-hvm
Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-08f89e200e88de0a8
    ap-south-1:
      ami: ami-0f78570aad7eeb5aa
    eu-west-3:
      ami: ami-0e0bd42b114b5503b
    eu-west-2:
      ami: ami-065add86d7cb5546c
    eu-west-1:
      ami: ami-0493f1556c5a9487b
    ap-northeast-3:
      ami: ami-0a04d867e89af94f7
    ap-northeast-2:
      ami: ami-09641daa9f5b4f653
    ap-northeast-1:
      ami: ami-065833fccd269a826
    sa-east-1:
      ami: ami-04550496fa0ad3588
    ca-central-1:
      ami: ami-07f4344baeb0b0f45
    ap-southeast-1:
      ami: ami-0eb37bd2984c5a9f5
    ap-southeast-2:
      ami: ami-00f62389111618345
    eu-central-1:
      ami: ami-022a4ceac8bf0aaf3
    us-east-1:
      ami: ami-0e3f071c26aa4e35b
    us-east-2:
      ami: ami-0d4d895dc0330133e
    us-west-1:
      ami: ami-0a03280bc3c2c6b4a
    us-west-2:
      ami: ami-0b1d878053340e333
```

## Using the mappings in CloudFormation

The following CloudFormation template demonstrates how the mappings generated by the script can be used:

```yaml
Mappings:
  RegionMap:
    eu-north-1:
      ami: ami-08f89e200e88de0a8
    ap-south-1:
      ami: ami-0f78570aad7eeb5aa
    eu-west-3:
      ami: ami-0e0bd42b114b5503b
    eu-west-2:
      ami: ami-065add86d7cb5546c
    eu-west-1:
      ami: ami-0493f1556c5a9487b
    ap-northeast-3:
      ami: ami-0a04d867e89af94f7
    ap-northeast-2:
      ami: ami-09641daa9f5b4f653
    ap-northeast-1:
      ami: ami-065833fccd269a826
    sa-east-1:
      ami: ami-04550496fa0ad3588
    ca-central-1:
      ami: ami-07f4344baeb0b0f45
    ap-southeast-1:
      ami: ami-0eb37bd2984c5a9f5
    ap-southeast-2:
      ami: ami-00f62389111618345
    eu-central-1:
      ami: ami-022a4ceac8bf0aaf3
    us-east-1:
      ami: ami-0e3f071c26aa4e35b
    us-east-2:
      ami: ami-0d4d895dc0330133e
    us-west-1:
      ami: ami-0a03280bc3c2c6b4a
    us-west-2:
      ami: ami-0b1d878053340e333
Resources: 
  myEC2Instance: 
    Type: "AWS::EC2::Instance"
    Properties: 
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - ami
      InstanceType: m1.small
```

## Finding AMI names

You will notice from the command above that the AMI name must be passed as a parameter. However, the AWS console typically shows the AMI description, which is more user friendly. So how do you find the name from the AMI ID or description?

An easy solution is to open the **Images** link in the EC2 console. This allows public AMIs to be searched for either their ID or description, and the AMI details page then displays the AMI name:

![AMI Details page](ami-details.png)

Note that the name often includes the CPU architecture. For example, the AMI named `amzn2-ami-kernel-5.10-hvm-2.0.20210701.0-arm64-gp2` requires an ARM VM to run, while the AMI named `amzn2-ami-kernel-5.10-hvm-2.0.20211103.1-x86_64-gp2` requires an x86 VM. Make sure the name you search for includes the correct architecture for your desired platform.

## Conclusion

Keeping your CloudFormation templates up to date with the latest AMI IDs is a constant challenge and is made more complicated by the fact that every region has unique AMI IDs. In this post you learned how to generate up to date mappings with regional AMI IDs to copy and paste into your CloudFormation templates.
